<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Tools - Yearly Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: #2c3e50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0.75rem 0;
            border-bottom: 3px solid #3498db;
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: 600;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        
        .navbar-brand:hover {
            color: #3498db !important;
        }
        
        .navbar-toggler {
            border: none;
            padding: 0.25rem 0.5rem;
        }
        
        .navbar-toggler:focus {
            box-shadow: none;
        }
        
        .nav-link {
            color: #ecf0f1 !important;
            font-weight: 500;
            padding: 0.5rem 1rem !important;
            margin: 0 0.25rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-link:hover {
            color: white !important;
            background-color: #34495e;
        }
        
        .nav-link.active {
            color: white !important;
            font-weight: 600;
            background-color: #3498db;
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #3498db;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #003366 0%, #F47C20 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #003366 0%, #F47C20 100%) !important;
            border: none !important;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            border: none !important;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        
        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #003366;
            background-color: rgba(0, 51, 102, 0.05);
        }
        
        .upload-area.dragover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 51, 102, 0.2);
        }
        
        .file-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .file-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .file-item.drag-over {
            border-color: #003366;
            background-color: rgba(0, 51, 102, 0.1);
        }
        
        .file-order-indicator {
            background: #003366;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .btn {
            border-radius: 8px;
            font-weight: 500;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #003366;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .season-slope-selector {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .selector-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .selector-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0;
        }
        
        .selector-group select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 8px 15px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        
        .selector-group select:focus {
            border-color: #003366;
            box-shadow: 0 0 0 0.2rem rgba(0, 51, 102, 0.25);
            outline: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                Data Analysis Tools
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/data_combiner">
                            <i class="fas fa-object-group me-1"></i>Data Combiner
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/data_cleanup">
                            <i class="fas fa-broom me-1"></i>Data Cleanup
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/graph_generator">
                            <i class="fas fa-chart-bar me-1"></i>Graph Generator
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/slope_analyzer">
                            <i class="fas fa-chart-line me-1"></i>Slope Analyzer
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/yearly_comparison">
                            <i class="fas fa-calendar-alt me-1"></i>Yearly Comparison
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Yearly Comparison Analysis
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Upload Excel files with temperature data to compare trends across different years, seasons, and slopes. 
                            The system will automatically detect Min/Max temperature columns and create interactive visualizations.
                        </p>
                        
                        <!-- File Upload Area -->
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Drag & Drop Excel Files Here</h5>
                            <p class="text-muted">or click to browse files</p>
                            <input type="file" id="fileInput" multiple accept=".xlsx,.xls" style="display: none;">
                        </div>

                        <!-- File List -->
                        <div id="fileList" style="display: none;">
                            <h6><i class="fas fa-list me-2"></i>Uploaded Files</h6>
                            <div id="fileItems"></div>
                        </div>

                        <!-- Analysis Button -->
                        <div class="text-center mt-4" id="analyzeButton" style="display: none;">
                            <button class="btn btn-primary btn-lg" onclick="analyzeData()">
                                <i class="fas fa-chart-line me-2"></i>
                                Analyze Yearly Comparison
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="card" id="resultsCard" style="display: none;">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-2"></i>
                        Analysis Results
                    </div>
                    <div class="card-body">
                        <!-- Statistics -->
                        <div class="stats-grid" id="statsGrid">
                            <!-- Stats will be populated here -->
                        </div>

                        <!-- Season/Slope Selector -->
                        <div class="season-slope-selector">
                            <h6><i class="fas fa-filter me-2"></i>Select View</h6>
                            <div class="selector-group">
                                <div>
                                    <label for="seasonSelect">Season:</label>
                                    <select id="seasonSelect" onchange="updateCharts()">
                                        <option value="Summer">Summer</option>
                                        <option value="Fall">Fall</option>
                                        <option value="Winter">Winter</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="slopeSelect">Slope:</label>
                                    <select id="slopeSelect" onchange="updateCharts()">
                                        <option value="Positive">Positive</option>
                                        <option value="Negative">Negative</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="row">
                            <div class="col-12">
                                <div class="chart-container">
                                    <h6><i class="fas fa-chart-bar me-2"></i>Yearly Comparison Chart</h6>
                                    <p class="text-muted mb-3">Showing data for <span id="currentView">Summer â€¢ Positive</span></p>
                                    <div id="barChart"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Download Section -->
                        <div class="text-center mt-4">
                            <h6><i class="fas fa-download me-2"></i>Download Results</h6>
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-success" onclick="downloadData('csv')">
                                    <i class="fas fa-file-csv me-2"></i>
                                    Download CSV
                                </button>
                                <button class="btn btn-primary" onclick="downloadData('xlsx')">
                                    <i class="fas fa-file-excel me-2"></i>
                                    Download Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <div id="alerts"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3" id="loadingText">Analyzing data...</p>
            <div class="progress mt-3" style="width: 300px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     id="progressBar" 
                     style="width: 0%" 
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100">0%</div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let analysisData = null;

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });
        
        uploadArea.addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }

        function handleFiles(files) {
            const validFiles = files.filter(file => 
                file.name.toLowerCase().endsWith('.xlsx') || 
                file.name.toLowerCase().endsWith('.xls')
            );

            if (validFiles.length === 0) {
                showAlert('error', 'Please select valid Excel files (.xlsx or .xls)');
                return;
            }

            uploadedFiles = validFiles;
            displayFiles();
            showAlert('success', `${validFiles.length} Excel file(s) uploaded successfully!`);
        }

        function displayFiles() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');
            const analyzeButton = document.getElementById('analyzeButton');

            if (uploadedFiles.length > 0) {
                fileList.style.display = 'block';
                analyzeButton.style.display = 'block';

                fileItems.innerHTML = uploadedFiles.map((file, index) => `
                    <div class="file-item">
                        <div class="file-order-indicator">${index + 1}</div>
                        <strong>${file.name}</strong>
                        <small class="text-muted ms-2">(${(file.size / 1024).toFixed(1)} KB)</small>
                        <button class="btn btn-sm btn-outline-danger float-end" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            } else {
                fileList.style.display = 'none';
                analyzeButton.style.display = 'none';
            }
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFiles();
        }

        function analyzeData() {
            if (uploadedFiles.length === 0) {
                showAlert('error', 'Please upload files first');
                return;
            }

            showLoading('Analyzing yearly comparison data...');
            updateProgress(0, 'Starting analysis...');

            const formData = new FormData();
            uploadedFiles.forEach(file => {
                formData.append('files', file);
            });

            fetch('/yearly_comparison', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    analysisData = data;
                    showResults(data);
                    showAlert('success', 'Yearly comparison analysis completed successfully!');
                } else {
                    showAlert('error', data.error || 'Analysis failed');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Analysis error:', error);
                showAlert('error', 'Error during analysis: ' + error.message);
            });
        }

        function showResults(data) {
            console.log('ðŸŽ¯ Yearly comparison results received:', data);
            console.log('ðŸ“Š Chart data keys:', Object.keys(data.chart_data || {}));
            
            document.getElementById('resultsCard').style.display = 'block';
            
            // Update statistics
            updateStatistics(data);
            
            // Create initial chart with default selection
            updateCharts();
            
            // Scroll to results
            document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
        }

        function updateStatistics(data) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.total_years || 0}</div>
                    <div class="stat-label">Years Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.total_temp_ranges || 0}</div>
                    <div class="stat-label">Temperature Ranges</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.total_records || 0}</div>
                    <div class="stat-label">Data Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.seasons?.length || 0}</div>
                    <div class="stat-label">Seasons</div>
                </div>
            `;
        }

        function createBarChart(data, season, slope) {
            console.log(`ðŸ”§ Creating bar chart for ${season} â€¢ ${slope}`);
            console.log('ðŸ“Š Available chart data keys:', Object.keys(data.chart_data || {}));
            
            if (!data.chart_data) {
                console.log('âŒ No chart data available');
                return;
            }

            const key = `${season}_${slope}`;
            console.log(`ðŸ”‘ Looking for key: ${key}`);
            const chartData = data.chart_data[key];
            
            if (!chartData) {
                console.log(`âŒ No data found for ${season} â€¢ ${slope}`);
                console.log('ðŸ“‹ Available keys:', Object.keys(data.chart_data));
                return;
            }
            
            console.log('âœ… Chart data found:', chartData);

            // Create traces for each year
            const traces = [];
            const colors = ['#003366', '#F47C20', '#28a745', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c'];
            
            chartData.years.forEach((year, index) => {
                const yearData = chartData.data.map(row => row[index] || 0);
                
                traces.push({
                    x: chartData.temp_ranges,
                    y: yearData,
                    type: 'bar',
                    name: `Year ${year}`,
                    marker: {
                        color: colors[index % colors.length],
                        opacity: 0.8
                    },
                    hovertemplate: `Year: ${year}<br>Temp Range: %{x}<br>Value: %{y}<extra></extra>`
                });
            });

            const layout = {
                title: `${season} â€¢ ${slope}: Temperature Analysis by Year`,
                xaxis: { 
                    title: 'Temperature Range',
                    tickangle: -30
                },
                yaxis: { title: 'Value' },
                barmode: 'group',
                margin: { l: 50, r: 30, t: 90, b: 70 },
                legend: {
                    title: 'Year',
                    orientation: 'h',
                    y: -0.2
                }
            };

            Plotly.newPlot('barChart', traces, layout);
        }

        function updateCharts() {
            const season = document.getElementById('seasonSelect').value;
            const slope = document.getElementById('slopeSelect').value;
            
            // Update the current view display
            document.getElementById('currentView').textContent = `${season} â€¢ ${slope}`;
            
            if (analysisData && analysisData.chart_data) {
                console.log(`Updating charts for ${season} â€¢ ${slope}`);
                createBarChart(analysisData, season, slope);
            }
        }

        function downloadData(fileType) {
            if (!analysisData) {
                showAlert('error', 'No analysis data available');
                return;
            }

            // Create download link
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `yearly_comparison_${timestamp}.${fileType}`;
            
            let content, mimeType;
            if (fileType === 'csv') {
                content = analysisData.csv_content || '';
                mimeType = 'text/csv';
            } else if (fileType === 'xlsx') {
                content = analysisData.excel_content || '';
                mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('success', `Data downloaded as ${fileType.toUpperCase()} successfully!`);
        }

        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function updateProgress(percentage, message) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
            progressBar.textContent = Math.round(percentage) + '%';
        }

        function showAlert(type, message) {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            let alertClass = 'alert-';
            let icon = '';
            
            switch(type) {
                case 'success':
                    alertClass += 'success';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    alertClass += 'danger';
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'info':
                    alertClass += 'info';
                    icon = 'fas fa-info-circle';
                    break;
                default:
                    alertClass += 'primary';
                    icon = 'fas fa-info-circle';
            }
            
            alert.className = `alert ${alertClass} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alerts.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
