{% extends 'base.html' %}
{% block title %}Diagnostic Codes - Diagnostic Controller{% endblock %}

{% block content %}
<style>
    /* Custom popover styles */
    .popover {
        max-width: 300px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    .popover-body {
        padding: 10px;
        text-align: left;
    }
    
    .popover-body strong {
        color: #003366;
        display: block;
        margin-bottom: 5px;
        border-bottom: 1px solid #eee;
        padding-bottom: 3px;
    }
    
    .popover-body div {
        margin: 3px 0;
    }
    
    .badge {
        cursor: pointer;
        font-size: 0.9em;
        padding: 6px 10px;
    }
    
    .badge.bg-primary {
        background-color: #003366 !important;
    }
    
    .badge.bg-success {
        background-color: #28a745 !important;
    }

    .btn-group-action {
        display: flex;
        gap: 5px;
        flex-wrap: nowrap;
        min-width: 300px;
        justify-content: flex-start;
    }

    .btn-group-action form {
        margin: 0;
        white-space: nowrap;
    }

    .btn-group-action button {
        margin: 0;
        white-space: nowrap;
    }

    .btn-group-action a {
        white-space: nowrap;
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-12">
        <!-- Search Form -->
        <div class="card shadow p-4 mb-4">
            <form method="GET" action="{{ url_for('diagnostic_codes') }}" class="mb-0">
                <div class="input-group">
                    <input type="text" class="form-control" name="search" placeholder="Search in all fields..." value="{{ search_query }}">
                    <button class="btn btn-primary" type="submit" style="background-color: #003366; border-color: #003366;">
                        <i class="fas fa-search"></i> Search
                    </button>
                    {% if search_query %}
                    <a href="{{ url_for('diagnostic_codes') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Clear
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Temperature Section -->
        <div class="card shadow p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 style="color: #003366;">Temperature Diagnostic Codes</h2>
                <a href="/add_diagnostic_code?type=Temperature" class="btn btn-primary" style="background-color: #003366; border-color: #003366;">Add Code</a>
            </div>
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}
            <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Description</th>
                        <th>State</th>
                        <th>Last Failure</th>
                        <th>History</th>
                        <th>Data Source</th>
                        <th>Limits</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if temp_codes %}
                        {% for code in temp_codes %}
                        <tr>
                            <td data-label="Code">{{ code[1] }}</td>
                            <td data-label="Description">{{ code[2] }}</td>
                            <td data-label="State">{{ code[4] }}</td>
                            <td data-label="Last Failure">{{ code[5] }}</td>
                            <td data-label="History">{{ code[6] }}</td>
                            <td data-label="Data Source">
                                <span class="badge {% if code[7] == 'modbus' %}bg-primary{% else %}bg-success{% endif %}" 
                                      data-bs-toggle="popover" 
                                      data-bs-html="true"
                                      data-bs-content="{% if code[7] == 'modbus' %}
                                        <strong>Modbus Configuration</strong>
                                        <div><i class='fas fa-network-wired'></i> IP: {{ code[8] }}</div>
                                        <div><i class='fas fa-plug'></i> Port: {{ code[9] }}</div>
                                        <div><i class='fas fa-microchip'></i> Unit ID: {{ code[10] }}</div>
                                        <div><i class='fas fa-database'></i> Register: {{ code[11] }} ({{ code[12] }})</div>
                                        <div><i class='fas fa-code'></i> Type: {{ code[13] }}</div>
                                        <div><i class='fas fa-sort'></i> Order: {{ code[14] }}</div>
                                        <div><i class='fas fa-calculator'></i> Scale: {{ code[15] }} {{ code[16] }}</div>
                                        <div><i class='fas fa-plus-minus'></i> Offset: {{ code[17] }}</div>
                                        <div><i class='fas fa-function'></i> Function: {{ code[18] }}</div>
                                      {% else %}
                                        <strong>MQTT Configuration</strong>
                                        <div><i class='fas fa-server'></i> Broker: {{ code[19] }}</div>
                                        <div><i class='fas fa-plug'></i> Port: {{ code[20] }}</div>
                                        <div><i class='fas fa-broadcast-tower'></i> Topic: {{ code[21] }}</div>
                                        <div><i class='fas fa-user'></i> Username: {{ code[22] or 'None' }}</div>
                                        <div><i class='fas fa-shield-alt'></i> QoS: {{ code[24] }}</div>
                                      {% endif %}">
                                    <i class="fas {% if code[7] == 'modbus' %}fa-network-wired{% else %}fa-broadcast-tower{% endif %}"></i>
                                    {{ code[7]|upper }}
                                </span>
                            </td>
                            <td data-label="Limits">
                                Upper: {{ code[25] }}<br>
                                Lower: {{ code[26] }}
                            </td>
                            <td data-label="Status">
                                <form action="/toggle_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-sm {% if code[27] %}btn-success{% else %}btn-secondary{% endif %}">
                                        {% if code[27] %}Enabled{% else %}Disabled{% endif %}
                                    </button>
                                </form>
                            </td>
                            <td data-label="Actions">
                                <div class="btn-group-action">
                                    <a href="/edit_diagnostic_code/{{ code[0] }}" class="btn btn-sm btn-warning" title="Edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <form action="/duplicate_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-info" title="Duplicate">
                                            <i class="fas fa-copy"></i> Duplicate
                                        </button>
                                    </form>
                                    <form action="/reset_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-secondary" title="Reset" onclick="return confirm('Are you sure you want to reset this code?');">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                    </form>
                                    <form action="/delete_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this code?');">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="text-center">No temperature diagnostic codes found{% if search_query %} matching "{{ search_query }}"{% endif %}</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            </div>
        </div>

        <!-- Humidity Section -->
        <div class="card shadow p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 style="color: #003366;">Humidity Diagnostic Codes</h2>
                <a href="/add_diagnostic_code?type=Humidity" class="btn btn-primary" style="background-color: #003366; border-color: #003366;">Add Code</a>
            </div>
            <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Description</th>
                        <th>State</th>
                        <th>Last Failure</th>
                        <th>History</th>
                        <th>Data Source</th>
                        <th>Limits</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if humidity_codes %}
                        {% for code in humidity_codes %}
                        <tr>
                            <td data-label="Code">{{ code[1] }}</td>
                            <td data-label="Description">{{ code[2] }}</td>
                            <td data-label="State">{{ code[4] }}</td>
                            <td data-label="Last Failure">{{ code[5] }}</td>
                            <td data-label="History">{{ code[6] }}</td>
                            <td data-label="Data Source">
                                <span class="badge {% if code[7] == 'modbus' %}bg-primary{% else %}bg-success{% endif %}" 
                                      data-bs-toggle="popover" 
                                      data-bs-html="true"
                                      data-bs-content="{% if code[7] == 'modbus' %}
                                        <strong>Modbus Configuration</strong>
                                        <div><i class='fas fa-network-wired'></i> IP: {{ code[8] }}</div>
                                        <div><i class='fas fa-plug'></i> Port: {{ code[9] }}</div>
                                        <div><i class='fas fa-microchip'></i> Unit ID: {{ code[10] }}</div>
                                        <div><i class='fas fa-database'></i> Register: {{ code[11] }} ({{ code[12] }})</div>
                                        <div><i class='fas fa-code'></i> Type: {{ code[13] }}</div>
                                        <div><i class='fas fa-sort'></i> Order: {{ code[14] }}</div>
                                        <div><i class='fas fa-calculator'></i> Scale: {{ code[15] }} {{ code[16] }}</div>
                                        <div><i class='fas fa-plus-minus'></i> Offset: {{ code[17] }}</div>
                                        <div><i class='fas fa-function'></i> Function: {{ code[18] }}</div>
                                      {% else %}
                                        <strong>MQTT Configuration</strong>
                                        <div><i class='fas fa-server'></i> Broker: {{ code[19] }}</div>
                                        <div><i class='fas fa-plug'></i> Port: {{ code[20] }}</div>
                                        <div><i class='fas fa-broadcast-tower'></i> Topic: {{ code[21] }}</div>
                                        <div><i class='fas fa-user'></i> Username: {{ code[22] or 'None' }}</div>
                                        <div><i class='fas fa-shield-alt'></i> QoS: {{ code[24] }}</div>
                                      {% endif %}">
                                    <i class="fas {% if code[7] == 'modbus' %}fa-network-wired{% else %}fa-broadcast-tower{% endif %}"></i>
                                    {{ code[7]|upper }}
                                </span>
                            </td>
                            <td data-label="Limits">
                                Upper: {{ code[25] }}<br>
                                Lower: {{ code[26] }}
                            </td>
                            <td data-label="Status">
                                <form action="/toggle_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-sm {% if code[27] %}btn-success{% else %}btn-secondary{% endif %}">
                                        {% if code[27] %}Enabled{% else %}Disabled{% endif %}
                                    </button>
                                </form>
                            </td>
                            <td data-label="Actions">
                                <div class="btn-group-action">
                                    <a href="/edit_diagnostic_code/{{ code[0] }}" class="btn btn-sm btn-warning" title="Edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <form action="/duplicate_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-info" title="Duplicate">
                                            <i class="fas fa-copy"></i> Duplicate
                                        </button>
                                    </form>
                                    <form action="/reset_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-secondary" title="Reset" onclick="return confirm('Are you sure you want to reset this code?');">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                    </form>
                                    <form action="/delete_diagnostic_code/{{ code[0] }}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this code?');">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="text-center">No humidity diagnostic codes found{% if search_query %} matching "{{ search_query }}"{% endif %}</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            html: true,
            placement: 'right',
            trigger: 'hover',
            delay: { show: 50, hide: 50 },
            sanitize: false
        })
    })
});
</script>
{% endblock %} 