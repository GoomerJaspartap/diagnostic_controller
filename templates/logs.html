{% extends 'base.html' %}
{% block title %}Logs - Diagnostic Controller{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4" style="color: #003366;">Logs</h2>
    <form id="filter-form" class="row g-3 mb-3">
        <div class="col-md-2">
            <label for="code" class="form-label">Code</label>
            <input type="text" class="form-control" id="code" name="code" placeholder="Enter code">
        </div>
        <div class="col-md-2">
            <label for="state" class="form-label">State</label>
            <select class="form-select" id="state" name="state">
                <option value="">All States</option>
                <option value="Fail">Fail</option>
                <option value="No Status">No Status</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="type" class="form-label">Type</label>
            <select class="form-select" id="type" name="type">
                <option value="">All Types</option>
                <option value="Temperature">Temperature</option>
                <option value="Humidity">Humidity</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="start_date" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="start_date" name="start_date" placeholder="Select start date">
        </div>
        <div class="col-md-2">
            <label for="end_date" class="form-label">End Date</label>
            <input type="date" class="form-control" id="end_date" name="end_date" placeholder="Select end date">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
    </form>
    <div class="table-responsive">
        <table class="table table-striped" id="logs-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>State</th>
                    <th>Value</th>
                    <th>Last Failure</th>
                    <th>History Count</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script>
function fetchLogs() {
    const form = document.getElementById('filter-form');
    const params = new URLSearchParams(new FormData(form)).toString();
    fetch('/api/logs?' + params)
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector('#logs-table tbody');
            tbody.innerHTML = '';
            if (data.logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No logs found.</td></tr>';
                return;
            }
            data.logs.forEach(log => {
                tbody.innerHTML += `<tr>
                    <td data-label="Time">${log.event_time}</td>
                    <td data-label="Code">${log.code}</td>
                    <td data-label="Description">${log.description}</td>
                    <td data-label="Type">${log.type}</td>
                    <td data-label="State"><strong style="${log.state === 'Fail' ? 'color: #dc3545;' : log.state === 'No Status' ? 'color: #ffc107;' : 'color: #28a745;'}">${log.state}</strong></td>
                    <td data-label="Value">${log.value !== null ? log.value : ''}</td>
                    <td data-label="Last Failure">${log.last_failure || ''}</td>
                    <td data-label="History Count">${log.history_count}</td>
                </tr>`;
            });
        });
}
document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    fetchLogs();
});
window.onload = function() {
    fetchLogs();
    setInterval(fetchLogs, 1000); // Auto-refresh every 1 second
};
</script>
{% endblock %} 