{% extends 'base.html' %}
{% block title %}Dashboard - Diagnostic Controller{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <!-- Controls Section -->
        <div class="row mb-3">
            <!-- Refresh Time Controls -->
            <div class="col-12 col-md-6 mb-2 mb-md-0">
                <div class="d-flex flex-wrap align-items-center">
                    <label for="refreshTime" class="me-2 mb-2 mb-md-0">Modbus Refresh Time (seconds):</label>
                    <div class="d-flex">
                        <input type="number" id="refreshTime" class="form-control" style="width: 100px;" min="1" value="5">
                        <button id="updateRefreshTimeBtn" class="btn btn-primary ms-2">
                            <i class="fas fa-sync"></i> Update
                        </button>
                        <button id="readNowBtn" class="btn btn-success ms-2">
                            <i class="fas fa-bolt"></i> Read Modbus
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Contact Stats and Reset Button -->
            <div class="col-12 col-md-6">
                <div class="d-flex flex-wrap justify-content-md-end align-items-center">
                    <div class="me-3 mb-2 mb-md-0">
                        <a href="{{ url_for('contacts') }}" style="text-decoration: none;">
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-info" style="font-size: 1.1em; padding: 8px 12px; cursor: pointer;">
                                    <i class="fas fa-envelope me-1"></i> Email: {{ email_enabled }}/{{ total_contacts }}
                                </span>
                                <span class="badge bg-info" style="font-size: 1.1em; padding: 8px 12px; cursor: pointer;">
                                    <i class="fas fa-phone me-1"></i> SMS: {{ sms_enabled }}/{{ total_contacts }}
                                </span>
                            </div>
                        </a>
                    </div>
                    <button id="resetHistoryBtn" class="btn btn-warning">
                        <i class="fas fa-history"></i> Reset All History
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification Center -->
        <div id="notification-center">
            {% if notifications and notifications|length > 0 %}
            <div class="alert alert-warning mb-4">
                <strong>Notification Center:</strong>
                <ul class="mb-0" id="notification-list">
                    {% for n in notifications %}
                        <li>
                            <strong>{{ n[0] }}</strong> ({{ n[1] }}) - <span {% if n[2] == 'Fail' %}style="color: red; font-weight: bold;"{% elif n[2] == 'No Status' %}style="color: orange; font-weight: bold;"{% else %}style="font-weight: bold;"{% endif %}>{{ n[2] }}</span>
                            {% if n[3] %} | Last Failure: {{ n[3] }}{% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

        <div class="card shadow p-4 mb-4">
            <h4 style="color: #003366;">Humidity Diagnostics</h4>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Description</th>
                            <th>Current Value</th>
                            <th>State</th>
                            <th>Last Failure</th>
                            <th>History</th>
                            <th>Last Read</th>
                        </tr>
                    </thead>
                    <tbody id="humidity-codes-body">
                        {% for code in humidity_codes %}
                        <tr {% if code[2] == 'Pass' %}style="background-color: #d4edda !important;"{% elif code[2] == 'Fail' %}style="background-color: #f44336 !important; color: #fff;"{% elif code[2] == 'No Status' %}style="background-color: #ffe066 !important;"{% endif %}>
                            <td data-label="Code">{{ code[0] }}</td>
                            <td data-label="Description">{{ code[1] }}</td>
                            <td data-label="Current Value">{{ code[7] if code[7] is not none else 'N/A' }} {{ code[6] }}</td>
                            <td data-label="State"><strong style="{% if code[2] == 'Pass' %}color: #28a745;{% elif code[2] == 'Fail' %}color: #dc3545;{% else %}color: #ffc107;{% endif %}">{{ code[2] }}</strong></td>
                            <td data-label="Last Failure">{{ code[3] }}</td>
                            <td data-label="History">{{ code[4] }}</td>
                            <td data-label="Last Read">{{ code[8] if code[8] else 'Never' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card shadow p-4 mb-4">
            <h4 style="color: #003366;">Temperature Diagnostics</h4>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Description</th>
                            <th>Current Value</th>
                            <th>State</th>
                            <th>Last Failure</th>
                            <th>History</th>
                            <th>Last Read</th>
                        </tr>
                    </thead>
                    <tbody id="temp-codes-body">
                        {% for code in temp_codes %}
                        <tr {% if code[2] == 'Pass' %}style="background-color: #d4edda !important;"{% elif code[2] == 'Fail' %}style="background-color: #f44336 !important; color: #fff;"{% elif code[2] == 'No Status' %}style="background-color: #ffe066 !important;"{% endif %}>
                            <td data-label="Code">{{ code[0] }}</td>
                            <td data-label="Description">{{ code[1] }}</td>
                            <td data-label="Current Value">{{ code[7] if code[7] is not none else 'N/A' }} {{ code[6] }}</td>
                            <td data-label="State"><strong style="{% if code[2] == 'Pass' %}color: #28a745;{% elif code[2] == 'Fail' %}color: #dc3545;{% else %}color: #ffc107;{% endif %}">{{ code[2] }}</strong></td>
                            <td data-label="Last Failure">{{ code[3] }}</td>
                            <td data-label="History">{{ code[4] }}</td>
                            <td data-label="Last Read">{{ code[8] if code[8] else 'Never' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Add refresh time functionality
function loadRefreshTime() {
    fetch('/api/refresh_time')
        .then(response => response.json())
        .then(data => {
            document.getElementById('refreshTime').value = data.refresh_time;
        })
        .catch(error => console.error('Error loading refresh time:', error));
}

document.getElementById('updateRefreshTimeBtn').addEventListener('click', function() {
    const newTime = parseInt(document.getElementById('refreshTime').value);
    if (newTime < 1) {
        alert('Refresh time must be at least 1 second');
        return;
    }

    fetch('/api/refresh_time', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ refresh_time: newTime })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Refresh time updated successfully!');
        } else {
            alert('Error updating refresh time: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating refresh time. Please try again.');
    });
});

// Add Read Now functionality
document.getElementById('readNowBtn').addEventListener('click', function() {
    const button = this;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reading...';

    fetch('/api/read_now', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the diagnostics display
            updateDiagnostics();
            // Show success message
            alert('Modbus read completed successfully!');
        } else {
            alert('Error reading Modbus: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error reading Modbus. Please try again.');
    })
    .finally(() => {
        // Re-enable the button
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-bolt"></i> Read Now';
    });
});

// Load refresh time when page loads
loadRefreshTime();

function updateDiagnostics() {
    fetch('/api/diagnostics')
        .then(response => response.json())
        .then(data => {
            // Update humidity codes
            const humidityBody = document.getElementById('humidity-codes-body');
            humidityBody.innerHTML = data.humidity_codes.map(code => `
                <tr ${code[2] === 'Pass' ? 'style="background-color: #d4edda !important;"' : 
                     code[2] === 'Fail' ? 'style="background-color: #f44336 !important; color: #fff;"' : 
                     'style="background-color: #ffe066 !important;"'}>
                    <td data-label="Code">${code[0]}</td>
                    <td data-label="Description">${code[1]}</td>
                    <td data-label="Current Value">${code[7] !== null ? code[7] + ' ' + code[6] : 'N/A'}</td>
                    <td data-label="State"><strong style="${code[2] === 'Pass' ? 'color: #28a745;' : code[2] === 'Fail' ? 'color: #dc3545;' : 'color: #ffc107;'}">${code[2]}</strong></td>
                    <td data-label="Last Failure">${code[3] || ''}</td>
                    <td data-label="History">${code[4]}</td>
                    <td data-label="Last Read">${code[8] || 'Never'}</td>
                </tr>
            `).join('');

            // Update temperature codes
            const tempBody = document.getElementById('temp-codes-body');
            tempBody.innerHTML = data.temp_codes.map(code => `
                <tr ${code[2] === 'Pass' ? 'style="background-color: #d4edda !important;"' : 
                     code[2] === 'Fail' ? 'style="background-color: #f44336 !important; color: #fff;"' : 
                     'style="background-color: #ffe066 !important;"'}>
                    <td data-label="Code">${code[0]}</td>
                    <td data-label="Description">${code[1]}</td>
                    <td data-label="Current Value">${code[7] !== null ? code[7] + ' ' + code[6] : 'N/A'}</td>
                    <td data-label="State"><strong style="${code[2] === 'Pass' ? 'color: #28a745;' : code[2] === 'Fail' ? 'color: #dc3545;' : 'color: #ffc107;'}">${code[2]}</strong></td>
                    <td data-label="Last Failure">${code[3] || ''}</td>
                    <td data-label="History">${code[4]}</td>
                    <td data-label="Last Read">${code[8] || 'Never'}</td>
                </tr>
            `).join('');

            // Update notifications
            const notificationCenter = document.getElementById('notification-center');
            if (data.notifications && data.notifications.length > 0) {
                notificationCenter.innerHTML = `
                    <div class="alert alert-warning mb-4">
                        <strong>Notification Center:</strong>
                        <ul class="mb-0" id="notification-list">
                            ${data.notifications.map(n => `
                                <li>
                                    <strong>${n[0]}</strong> (${n[1]}) - 
                                    <span style="${n[2] === 'Fail' ? 'color: red; font-weight: bold;' : 
                                                 n[2] === 'No Status' ? 'color: orange; font-weight: bold;' : 
                                                 'font-weight: bold;'}">${n[2]}</span>
                                    ${n[3] ? ` | Last Failure: ${n[3]}` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else {
                notificationCenter.innerHTML = '';
            }

            // Update contact counter
            const contactCounter = document.querySelector('.badge.bg-info');
            if (contactCounter && data.contact_stats) {
                const contactContainer = document.querySelector('.d-flex.gap-2');
                if (contactContainer) {
                    contactContainer.innerHTML = `
                        <span class="badge bg-info" style="font-size: 1.1em; padding: 8px 12px; cursor: pointer;">
                            <i class="fas fa-envelope me-1"></i> Email: ${data.contact_stats.email_enabled}/${data.contact_stats.total}
                        </span>
                        <span class="badge bg-info" style="font-size: 1.1em; padding: 8px 12px; cursor: pointer;">
                            <i class="fas fa-phone me-1"></i> SMS: ${data.contact_stats.sms_enabled}/${data.contact_stats.total}
                        </span>
                    `;
                }
            }
        })
        .catch(error => console.error('Error fetching diagnostics:', error));
}

// Add reset history functionality
document.getElementById('resetHistoryBtn').addEventListener('click', function() {
    if (confirm('Are you sure you want to reset all diagnostic code histories? This will clear all failure records and set states to "No Status".')) {
        fetch('/api/reset_history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Immediately update the display
                updateDiagnostics();
                // Show success message
                alert('History reset successfully!');
            } else {
                alert('Error resetting history: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error resetting history. Please try again.');
        });
    }
});

// Update every second
setInterval(updateDiagnostics, 1000);
</script>
{% endblock %} 